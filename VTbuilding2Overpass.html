<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Display a map</title>
    <meta
      property="og:description"
      content="Initialize a map in an HTML element with MapLibre GL JS."
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      const map = new maplibregl.Map({
        container: "map", // container id
        style: "./VTbuilding2Overpass.json", // style URL
        // style:
        //   "https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL", // style URL
        center: [139.471321, 35.758044], // starting position [lng, lat]
        zoom: 16, // starting zoom
        bearing: -27,
        pitch: 54,
        hash: true,
      });

      //UI
      map.addControl(new maplibregl.NavigationControl(), "bottom-right");
      map.addControl(new maplibregl.ScaleControl());

      //debug
      map.showTileBoundaries = true;
      map.showCollisionBoxes = false;

      let hoveredStateId = null;
      style.layers
        .filter((a) => a.id.indexOf("bldg") === 0)
        .forEach((layer) => {
          const id = layer.id;
          // When a click event occurs on a feature in the places layer, open a popup at the
          // location of the feature, with description HTML from its properties.
          map.on("click", id, function (e) {
            const dl = document.createElement("dl");
            const prop = e.features[0].properties;
            const html =
              "<div class='my-popup'>" +
              Object.keys(prop)
                .map((k) => `<b>${k}</b> <span>${prop[k]}</span>`)
                .join("<br/>") +
              "</div>";
            new maplibregl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
          });

          // Change the cursor to a pointer when the mouse is over the places layer.
          map.on("mouseenter", id, function () {
            map.getCanvas().style.cursor = "pointer";
          });

          // Change it back to a pointer when it leaves.
          map.on("mouseleave", id, function () {
            map.getCanvas().style.cursor = "";
            if (hoveredStateId) {
              map.setFeatureState(
                {
                  source: "plateau",
                  id: hoveredStateId,
                  sourceLayer: "bldg",
                },
                {
                  hover: false,
                }
              );
            }
            hoveredStateId = null;
          });

          // When the user moves their mouse over the state-fill layer, we'll update the
          // feature state for the feature under the mouse.
          map.on("mousemove", id, function (e) {
            if (e.features.length > 0) {
              if (hoveredStateId) {
                map.setFeatureState(
                  {
                    source: "plateau",
                    id: hoveredStateId,
                    sourceLayer: "bldg",
                  },
                  {
                    hover: false,
                  }
                );
              }
              hoveredStateId = e.features[0].id;
              map.setFeatureState(
                {
                  source: "plateau",
                  id: hoveredStateId,
                  sourceLayer: "bldg",
                },
                {
                  hover: true,
                }
              );
            }
          });
        });
    </script>
  </body>
</html>
